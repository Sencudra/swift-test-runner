#!/usr/bin/env bash

# Synopsis:
# Test the test runner Docker image by running it against a predefined set of 
# solutions with an expected output.
# The test runner Docker image is built automatically.

# Output:
# Outputs the diff of the expected test results against the actual test results
# generated by the test runner Docker image.

# Example:
# ./bin/run-tests-in-docker.sh

# Build the Docker image
docker build --rm -t exercism/swift-test-runner .

exit_code=0

# Iterate over all test directories
work_dir=/opt/test-runner/
for test_dir in tests/*; do
    test_name=$(basename $test_dir)
    dst_test_dir=${work_dir}/${test_name}
    docker run \
        --network none \
        --mount type=bind,src=${PWD}/${test_dir},dst=${dst_test_dir} \
        --mount type=volume,dst=/tmp \
        --workdir "${work_dir}" \
        --entrypoint ${work_dir}/bin/run-test.sh \
        exercism/swift-test-runner \
        "${dst_test_dir}"

    if [ $? -ne 0 ]; then
        printf 'Test "%s" failed!\n' "$test_name" 
        exit_code=1
    fi
done

exit ${exit_code}